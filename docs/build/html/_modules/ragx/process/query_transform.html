
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ragx.process.query_transform &#8212; RAGX 1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../_static/documentation_options.js?v=a681ed88"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/ragx/process/query_transform';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">RAGX 1.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">API Documentation:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../modules.html">src</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../ragx.html">ragx package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.data.html">ragx.data package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.embs.html">ragx.embs package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.eval.html">ragx.eval package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.index.html">ragx.index package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.launcher.html">ragx.launcher package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.llms.html">ragx.llms package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.process.html">ragx.process package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.retrievers.html">ragx.retrievers package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../ragx.webui.html">ragx.webui package</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for ragx.process.query_transform</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">llama_index.core.indices.query.query_transform</span> <span class="kn">import</span> <span class="n">HyDEQueryTransform</span>
<span class="kn">from</span> <span class="nn">llama_index.llms.openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="nn">llama_index.core</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span> <span class="nn">llama_index.core.prompts.prompt_type</span> <span class="kn">import</span> <span class="n">PromptType</span>
<span class="kn">from</span> <span class="nn">llama_index.core.tools</span> <span class="kn">import</span> <span class="n">QueryEngineTool</span><span class="p">,</span> <span class="n">ToolMetadata</span>
<span class="kn">from</span> <span class="nn">llama_index.core.query_engine</span> <span class="kn">import</span> <span class="n">SubQuestionQueryEngine</span>
<span class="kn">from</span> <span class="nn">llama_index.question_gen.openai</span> <span class="kn">import</span> <span class="n">OpenAIQuestionGenerator</span>
<span class="kn">from</span> <span class="nn">llama_index.core.schema</span> <span class="kn">import</span> <span class="n">NodeWithScore</span><span class="p">,</span> <span class="n">TextNode</span>

<span class="kn">from</span> <span class="nn">..llms</span> <span class="kn">import</span> <span class="n">llm</span>
<div class="viewcode-block" id="transform_and_query">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.transform_and_query">[docs]</a>
<span class="k">def</span> <span class="nf">transform_and_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;subquery_zeroshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subquery_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;subquery_fewshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subquery_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_engine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cfg</span><span class="p">))</span></div>



<div class="viewcode-block" id="transform">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.transform">[docs]</a>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
    <span class="c1"># parser.add_argument(&#39;--query_transform&#39;, type=str, default=&#39;none&#39;, help=&#39;query transform, available: none, hyde_zeroshot, hyde_fewshot, stepback_zeroshot, stepback_fewshot, subquery_zeroshot, subquery_fewshot&#39;)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;hyde_zeroshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hyde_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;hyde_fewshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hyde_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;stepback_zeroshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stepback_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span> <span class="o">==</span> <span class="s2">&quot;stepback_fewshot&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stepback_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown query transform: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">query_transform</span><span class="p">)</span></div>



<div class="viewcode-block" id="hyde">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.hyde">[docs]</a>
<span class="k">def</span> <span class="nf">hyde</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">prompt_template_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query改写 - HyDE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HYDE_PROMPT</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">prompt_template_str</span><span class="p">,</span> <span class="n">prompt_type</span><span class="o">=</span><span class="n">PromptType</span><span class="o">.</span><span class="n">SUMMARY</span><span class="p">)</span>
    <span class="n">hyde</span> <span class="o">=</span> <span class="n">HyDEQueryTransform</span><span class="p">(</span><span class="n">include_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hyde_prompt</span><span class="o">=</span><span class="n">HYDE_PROMPT</span><span class="p">)</span>
    <span class="n">query_hyde</span> <span class="o">=</span> <span class="n">hyde</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
            <span class="n">query_hyde</span><span class="o">.</span><span class="n">custom_embedding_strs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">query_hyde</span><span class="o">.</span><span class="n">custom_embedding_strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="hyde_zeroshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.hyde_zeroshot">[docs]</a>
<span class="k">def</span> <span class="nf">hyde_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query改写 - HyDE - zeroshot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HYDE_TMPL_ZEROSHOT</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Please write a passage to answer the question</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Try to include as many key details as possible.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Here is your task:&quot;</span>
        <span class="s2">&quot;Question: </span><span class="si">{context_str}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: &quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">hyde</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">HYDE_TMPL_ZEROSHOT</span><span class="p">)</span></div>



<div class="viewcode-block" id="hyde_fewshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.hyde_fewshot">[docs]</a>
<span class="k">def</span> <span class="nf">hyde_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query改写 - HyDE - fewshot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HYDE_TMPL_FEWSHOT</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Please write a passage to answer the question</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Try to include as many key details as possible.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Here are a few examples:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s1">&#39;Passage:&quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s2">&quot;1.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Question: What is Bel?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: Bel is a term that has multiple meanings and can be interpreted in various ways depending on the context. In ancient Mesopotamian mythology, Bel was a prominent deity and the god of the heavens and earth. He was considered the supreme god and was often associated with the city of Babylon. Bel was believed to have control over the forces of nature and was worshipped by the Babylonians through elaborate rituals and offerings.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;In addition to its mythological significance, Bel is also a title given to individuals who hold high positions of authority or leadership. For example, in the ancient Near East, the title of Bel was used to refer to the ruler or king of a city-state. This title denoted power, influence, and the ability to govern and make important decisions.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Furthermore, Bel is also a term used in the field of linguistics to refer to a unit of sound or phoneme. In phonetics, a bel represents a logarithmic unit used to measure the intensity or loudness of sound. This unit is named after Alexander Graham Bell, the inventor of the telephone, who made significant contributions to the study of sound and communication.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Overall, the term Bel encompasses a range of meanings and can refer to a mythical deity, a title of authority, or a unit of sound measurement. Its significance varies depending on the context in which it is used, highlighting the diverse nature of this term.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;2.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Question: At It Again contains lyrics co-written by the singer and actor from what city?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: The song &#39;At It Again&#39; features lyrics that were co-written by the singer and actor who hail from the vibrant city of Los Angeles. This city, known for its thriving entertainment industry, has been a hub for countless talented individuals who have made their mark in music, film, and television. The singer and actor, both born and raised in Los Angeles, have been deeply influenced by the diverse and creative atmosphere of their hometown. Their collaboration on &#39;At It Again&#39; showcases their unique perspectives and storytelling abilities, as they draw inspiration from their personal experiences and the rich cultural tapestry of Los Angeles. Through their lyrics, they paint a vivid picture of the city&#39;s energy, its dreams, and its challenges, capturing the essence of their beloved hometown in every verse.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;3.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Question: What year was the English actor and film producer born in who also starred in an adaptation with Renee Zellweger?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: The English actor and film producer who starred alongside Renee Zellweger in a film adaptation is Hugh Grant. Born on September 9, 1960, Grant has had a prolific career in the film industry, particularly known for his roles in romantic comedies. He is a native of Hammersmith, London, and he attended the New College at the University of Oxford, where he studied English literature.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Grant&#39;s breakthrough role came in 1994 when he starred in &#39;Four Weddings and a Funeral.&#39; His performance in this film garnered him international recognition and established his reputation as a leading man in romantic comedy films. His charm and unique comedic timing resonated with audiences worldwide, making him a favorite in the genre.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;In 2001, Grant starred in the film adaptation of &#39;Bridget Jones&#39;s Diary,&#39; alongside American actress Renee Zellweger. The film, based on Helen Fielding&#39;s popular novel, was a commercial success, grossing over $280 million worldwide. Grant played the character of Daniel Cleaver, a charming yet unreliable publishing executive who becomes involved in a love triangle with Bridget Jones (Zellweger) and Mark Darcy (Colin Firth).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&#39;Bridget Jones&#39;s Diary&#39; was well-received by critics, and it led to two sequels in which Grant reprised his role. His performance in these films is often considered one of his most memorable. Despite the various challenges in his career, Hugh Grant has remained a significant figure in the film industry for over three decades. His enduring appeal and talent have ensured his place in the annals of cinematic history.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;4.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Question: What is the length of the track where the 2013 Liqui Moly Bathurst 12 Hour was staged?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: The 2013 Liqui Moly Bathurst 12 Hour race was held at the iconic Mount Panorama Circuit, situated in Bathurst, New South Wales, Australia. This particular motor racing track is known not only for its challenging layout but also for the spectacular views it offers of the surrounding countryside.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The Mount Panorama Circuit is a unique blend of seemingly contrasting elements. It is comprised of both long and short straights, fast corners, as well as dramatic ascents and descents, which demand a high level of skill and precision from the drivers. The track&#39;s total length is approximately 6.213 kilometers, or about 3.861 miles, a distance that has remained consistent over the years.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The Mount Panorama Circuit is steeped in motor racing history. It was first opened in 1938 and has since been the venue for a variety of prestigious motor racing events. These include not only the Bathurst 12 Hour, but also the Bathurst 1000, the latter of which is considered one of the most significant events in Australian motorsport.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The 2013 Liqui Moly Bathurst 12 Hour race was a significant event in the racing calendar. Teams from around the world competed in a gruelling endurance race that tested not only the performance of the cars but also the stamina and skill of the drivers. The race, which started in the early morning darkness, ran for twelve hours, with the victors crossing the finish line as the sun was setting, adding to the drama and spectacle of the event.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The Mount Panorama Circuit&#39;s unique combination of high-speed straights and tight corners, along with its significant changes in elevation, make it one of the most challenging and exciting circuits in the world. Its length and layout have remained largely unchanged since its inception, providing a consistent benchmark for drivers and teams across different racing events. It&#39;s a track that demands respect from every driver who races on it, and the 2013 Liqui Moly Bathurst 12 Hour was no exception.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;5.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Question: Which event was a surprise military strike by the Imperial Japanese Navy Air Service while Magruder Hill Tuttle was a senior officer in the United States Navy?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: The event that was a surprise military strike by the Imperial Japanese Navy Air Service while Magruder Hill Tuttle was a senior officer in the United States Navy was the infamous attack on Pearl Harbor. On the morning of December 7, 1941, the peaceful tranquility of the Hawaiian naval base was shattered as a fleet of Japanese aircraft descended upon the unsuspecting American forces stationed there. Tuttle, who held a senior position within the US Navy, found himself thrust into the chaos and confusion of the surprise attack.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The Japanese planes unleashed a devastating assault, targeting the American battleships, cruisers, and aircraft on the island. The attack was swift and relentless, catching the US Navy off guard and causing immense destruction and loss of life. Tuttle, along with his fellow officers and sailors, valiantly fought back against the overwhelming enemy forces, but the surprise nature of the attack made it difficult to mount an effective defense.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The attack on Pearl Harbor marked a turning point in World War II, propelling the United States into the conflict and forever changing the course of history.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Here is your task:&quot;</span>
        <span class="s2">&quot;Question: </span><span class="si">{context_str}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Passage: &quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">hyde</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">HYDE_TMPL_FEWSHOT</span><span class="p">)</span></div>



<div class="viewcode-block" id="stepback">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.stepback">[docs]</a>
<span class="k">def</span> <span class="nf">stepback</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">prompt_template_str</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query扩写 - Stepback</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stepback_query_gen_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">prompt_template_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">stepback_query_gen_prompt</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">query</span></div>



<div class="viewcode-block" id="stepback_zeroshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.stepback_zeroshot">[docs]</a>
<span class="k">def</span> <span class="nf">stepback_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query扩写 - Stepback - zeroshot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stepback_query_gen_str_zeroshot</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    You are an expert at world knowledge. Your task is to step back and paraphrase a question to a more generic step-back question, which is easier to answer.</span>
<span class="s2">    Just give the content of the Stepback Question.</span>

<span class="s2">    Here is your task:</span>
<span class="s2">    Original Question: </span><span class="si">{query}</span>
<span class="s2">    Stepback Question: </span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stepback</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">stepback_query_gen_str_zeroshot</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span></div>



<div class="viewcode-block" id="stepback_fewshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.stepback_fewshot">[docs]</a>
<span class="k">def</span> <span class="nf">stepback_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query拆解 - Stepback - fewshot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stepback_query_gen_str_fewshot</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    You are an expert at world knowledge. Your task is to step back and paraphrase a question to a more generic step-back question, which is easier to answer.</span>
<span class="s2">    Just give the content of the Stepback Question.</span>

<span class="s2">    Here are a few examples:</span>

<span class="s2">    1.</span>
<span class="s2">    Original Question: Musician and satirist Allie Goertz wrote a song about the &quot;The Simpsons&quot; character Milhouse, who Matt Groening named after who?</span>
<span class="s2">    Stepback Question: Who are some notable figures that have influenced the names of &quot;The Simpsons&quot; characters?</span>

<span class="s2">    2.</span>
<span class="s2">    Original Question: Which plant&#39;s name is derived from the greek for &quot;bee,&quot; Melittis or Hovea?</span>
<span class="s2">    Stepback Question: What are the origins of the names for the plants Melittis and Hovea?</span>

<span class="s2">    3.</span>
<span class="s2">    Original Question: What American media franchise is centered on a series of monster films featuring Godzilla and King Kong?</span>
<span class="s2">    Stepback Question: What are some notable American media franchises that feature monster films?</span>

<span class="s2">    4.</span>
<span class="s2">    Original Question: Tar Creed Superfund site causing toxic areas and therefore reducing the population to what number in November 2010?</span>
<span class="s2">    Stepback Question: What impact has the Tar Creek Superfund site had on the population of nearby towns, such as Cardin, Oklahoma?</span>

<span class="s2">    5.</span>
<span class="s2">    Original Question: Who is likely to have represented and advanced Armenian music more, Art Laboe or Konstantin Orbelyan?</span>
<span class="s2">    Stepback Question: Who are some notable figures that have significantly contributed to the representation and advancement of Armenian music?</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">    Here is your task:</span>
<span class="s2">    Original Question: </span><span class="si">{query}</span>
<span class="s2">    Stepback Question: </span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">stepback</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">stepback_query_gen_str_fewshot</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span></div>



<div class="viewcode-block" id="subquery">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.subquery">[docs]</a>
<span class="k">def</span> <span class="nf">subquery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">prompt_template_str</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">):</span>
    <span class="n">query_engine_tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">QueryEngineTool</span><span class="p">(</span>
            <span class="n">query_engine</span><span class="o">=</span><span class="n">query_engine</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">ToolMetadata</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Data Source&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Data source for the query engine&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">subquery_engine</span> <span class="o">=</span> <span class="n">CustomSubQuestionQueryEngine</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span>
        <span class="n">query_engine_tools</span><span class="o">=</span><span class="n">query_engine_tools</span><span class="p">,</span>
        <span class="n">use_async</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">question_gen</span><span class="o">=</span><span class="n">OpenAIQuestionGenerator</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span>
            <span class="n">prompt_template_str</span><span class="o">=</span><span class="n">prompt_template_str</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">subquery_engine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>



<div class="viewcode-block" id="subquery_zeroshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.subquery_zeroshot">[docs]</a>
<span class="k">def</span> <span class="nf">subquery_zeroshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query拆解 - Subquery - zeroshot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ZEROSHOT_OPENAI_SUB_QUESTION_PROMPT_TMPL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    You are a world class state of the art agent.</span>

<span class="s2">    You have access to multiple tools, each representing a different data source or API.</span>
<span class="s2">    Each of the tools has a name and a description, formatted as a JSON dictionary.</span>
<span class="s2">    The keys of the dictionary are the names of the tools and the values are the </span><span class="se">\</span>
<span class="s2">    descriptions.</span>
<span class="s2">    Your purpose is to help answer a complex user question by generating a list of sub </span><span class="se">\</span>
<span class="s2">    questions that can be answered by the tools.</span>

<span class="s2">    These are the guidelines you consider when completing your task:</span>
<span class="s2">    * Be as specific as possible</span>
<span class="s2">    * The sub questions should be relevant to the user question</span>
<span class="s2">    * The sub questions should be answerable by the tools provided</span>
<span class="s2">    * You can generate multiple sub questions for each tool</span>
<span class="s2">    * Tools must be specified by their name, not their description</span>
<span class="s2">    * You don&#39;t need to use a tool if you don&#39;t think it&#39;s relevant</span>

<span class="s2">    Output the list of sub questions by calling the SubQuestionList function.</span>

<span class="s2">    ## Tools</span>
<span class="s2">    ```json</span>
<span class="s2">    </span><span class="si">{tools_str}</span>
<span class="s2">    ```</span>

<span class="s2">    ## User Question</span>
<span class="s2">    </span><span class="si">{query_str}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">subquery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ZEROSHOT_OPENAI_SUB_QUESTION_PROMPT_TMPL</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">)</span></div>



<div class="viewcode-block" id="subquery_fewshot">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.subquery_fewshot">[docs]</a>
<span class="k">def</span> <span class="nf">subquery_fewshot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query拆解 - Subquery - fewshot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FEWSHOT_OPENAI_SUB_QUESTION_PROMPT_TMPL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    You are a world class state of the art agent.</span>

<span class="s2">    You have access to multiple tools, each representing a different data source or API.</span>
<span class="s2">    Each of the tools has a name and a description, formatted as a JSON dictionary.</span>
<span class="s2">    The keys of the dictionary are the names of the tools and the values are the </span><span class="se">\</span>
<span class="s2">    descriptions.</span>
<span class="s2">    Your purpose is to help answer a complex user question by generating a list of sub </span><span class="se">\</span>
<span class="s2">    questions that can be answered by the tools.</span>

<span class="s2">    These are the guidelines you consider when completing your task:</span>
<span class="s2">    * Be as specific as possible</span>
<span class="s2">    * The sub questions should be relevant to the user question</span>
<span class="s2">    * The sub questions should be answerable by the tools provided</span>
<span class="s2">    * You can generate multiple sub questions for each tool</span>
<span class="s2">    * Tools must be specified by their name, not their description</span>
<span class="s2">    * You don&#39;t need to use a tool if you don&#39;t think it&#39;s relevant</span>

<span class="s2">    Here are a few examples:</span>

<span class="s2">    1.</span>
<span class="s2">    Question: What type of media does Tar Creek and Before Stonewall have in common?</span>
<span class="s2">    Sub questions:</span>
<span class="s2">    - What is the media type of Tar Creek?</span>
<span class="s2">    - What is the media type of Before Stonewall?</span>

<span class="s2">    2.</span>
<span class="s2">    Question: Which documentary was created first, Murderball or Year at Danger?</span>
<span class="s2">    Sub questions: </span>
<span class="s2">    - When was the documentary &quot;Murderball&quot; created?</span>
<span class="s2">    - When was the documentary &quot;Year at Danger&quot; created?</span>

<span class="s2">    3.</span>
<span class="s2">    Question: How was Paul Grahams life different before, during, and after YC?</span>
<span class="s2">    Sub questions:</span>
<span class="s2">    - What did Paul Graham work on before YC?</span>
<span class="s2">    - What did Paul Graham work on during YC?</span>
<span class="s2">    - What did Paul Graham work on after YC?</span>

<span class="s2">    4.</span>
<span class="s2">    Question: What role did Ed Roland and Adam Duritz perform in their respective bands, Collective Soul and Counting Crows?</span>
<span class="s2">    Sub questions: </span>
<span class="s2">    - What role did Ed Roland perform in the band Collective Soul?</span>
<span class="s2">    - What role did Adam Duritz perform in the band Counting Crows?</span>

<span class="s2">    5.</span>
<span class="s2">    Question: Did Down and Out in America or Lost in La Mancha win more awards?</span>
<span class="s2">    Sub questions: </span>
<span class="s2">    - How many awards did the movie &quot;Down and Out in America&quot; win?</span>
<span class="s2">    - How many awards did the movie &quot;Lost in La Mancha&quot; win?</span>

<span class="s2">    Output the list of sub questions by calling the SubQuestionList function.</span>

<span class="s2">    ## Tools</span>
<span class="s2">    ```json</span>
<span class="s2">    </span><span class="si">{tools_str}</span>
<span class="s2">    ```</span>

<span class="s2">    ## User Question</span>
<span class="s2">    </span><span class="si">{query_str}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">subquery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">FEWSHOT_OPENAI_SUB_QUESTION_PROMPT_TMPL</span><span class="p">,</span> <span class="n">query_engine</span><span class="p">)</span></div>



<div class="viewcode-block" id="CustomSubQuestionQueryEngine">
<a class="viewcode-back" href="../../../ragx.process.html#ragx.process.query_transform.CustomSubQuestionQueryEngine">[docs]</a>
<span class="k">class</span> <span class="nc">CustomSubQuestionQueryEngine</span><span class="p">(</span><span class="n">SubQuestionQueryEngine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_construct_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qa_pair</span><span class="p">):</span>
        <span class="n">node_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sub question: </span><span class="si">{</span><span class="n">qa_pair</span><span class="o">.</span><span class="n">sub_q</span><span class="o">.</span><span class="n">sub_question</span><span class="si">}</span><span class="se">\n</span><span class="s2">Response: </span><span class="si">{</span><span class="n">qa_pair</span><span class="o">.</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">qa_pair</span><span class="o">.</span><span class="n">sources</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">qa_pair</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">qa_pair</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">TextNode</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">node_text</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NodeWithScore</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span></div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By HZT
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, HZT.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>